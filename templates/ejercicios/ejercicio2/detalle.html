{% extends "base.html" %}
{% block title %}{{ ejercicio.titulo }} ¬∑ Python Academy{% endblock %}

{% block content %}

<style>
  .hero-ej{
    background:#f8fafc;
    border-bottom:1px solid rgba(0,0,0,.08);
    padding:52px 0;
  }
  .hero-ej .badge{border-radius:999px;padding:8px 14px;font-weight:700;}
  .hero-ej h1{font-weight:800;letter-spacing:-.02em;}
  .hero-ej p{max-width:920px;margin:0 auto;}

  /* Bot√≥n volver arriba */
  .hero-top-actions{
    display:flex;
    justify-content:center;
    margin-bottom:14px;
  }
  .btn-pill{border-radius:999px;padding:10px 22px;font-weight:700;}
  .btn-pill-sm{border-radius:999px;padding:8px 16px;font-weight:700;}

  .ej-wrap{padding:36px 0 70px;}
  .ej-panel{
    border-radius:18px;border:1px solid rgba(0,0,0,.08);
    box-shadow:0 10px 25px rgba(0,0,0,.05);
    background:#fff;padding:26px;
  }

  .ej-actions{
    margin-top:18px;padding-top:18px;
    border-top:1px solid rgba(0,0,0,.08);
    display:flex;justify-content:center;
  }

  .form-shell{margin-top:22px;display:flex;justify-content:center;}
  .form-card{
    width:100%;max-width:620px;
    border-radius:18px;border:1px solid rgba(0,0,0,.08);
    box-shadow:0 10px 25px rgba(0,0,0,.06);
    background:#fff;padding:22px;
  }
  .form-card *{max-width:100%;}

  /* Navegaci√≥n inferior (Anterior / Siguiente) */
  .ej-nav-bottom{
    margin-top:26px;
    padding-top:18px;
    border-top:1px solid rgba(0,0,0,.08);
    display:flex;
    justify-content:space-between;
    gap:12px;
    flex-wrap:wrap;
  }
  .ej-nav-bottom .btn{ min-width: 170px; }

  /* Bloques explicativos */
  .explain-card{
    border:1px solid rgba(0,0,0,.08);
    border-radius:16px;
    padding:18px;
    background:#fbfdff;
  }

  /* ‚úÖ C√ìDIGO: ahora s√≠ respeta saltos e indentaci√≥n */
  .code-box{
    background:#0b1220;
    color:#e6edf3;
    border-radius:14px;
    padding:14px;
    overflow:auto;
    font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
    font-size: 0.92rem;
    white-space: pre;     /* üî• CLAVE: respeta enter + espacios */
    margin: 0;            /* evita margenes raros del pre */
  }
  .hint{
    font-size: .95rem;
    color: #556;
  }
</style>

<!-- HERO -->
<section class="hero-ej">
  <div class="container text-center">

    <!-- ‚úÖ Volver al men√∫ -->
    <div class="hero-top-actions">
      <a href="{{ url_for('ejercicios') }}" class="btn btn-outline-secondary btn-pill-sm">
        <i class="bi bi-arrow-left me-1"></i> Volver al men√∫
      </a>
    </div>

    <span class="badge bg-primary mb-3">{{ ejercicio.tema }}</span>
    <h1 class="display-5 mb-2">{{ ejercicio.titulo }}</h1>
    <p class="lead text-muted">{{ ejercicio.descripcion }}</p>
  </div>
</section>

<!-- CONTENIDO -->
<section class="ej-wrap">
  <div class="container">
    <div class="ej-panel">

      <!-- ‚úÖ ENUNCIADO -->
      <div class="explain-card mb-4">
        <h4 class="fw-bold mb-2">üß© Enunciado</h4>
        <p class="mb-2">
          En este ejercicio vamos a crear un formulario de registro vehicular que env√≠a datos al servidor usando
          el m√©todo <b>POST</b>. Adem√°s, el usuario podr√° <b>subir una imagen</b> (foto del veh√≠culo) desde el navegador.
        </p>
        <p class="mb-0 hint">
          Objetivo: entender c√≥mo Flask recibe <b>datos</b> con <code>request.form</code> y c√≥mo recibe <b>archivos</b>
          con <code>request.files</code> (equivalente a <code>$_POST</code> y <code>$_FILES</code> en PHP).
        </p>
      </div>

      <!-- ‚úÖ EXPLICACI√ìN DETALLADA -->
      <div class="explain-card mb-4">
        <h4 class="fw-bold mb-3">üìå Explicaci√≥n del c√≥digo (paso a paso)</h4>

        <h5 class="fw-bold mb-2">0) Idea general (GET vs POST)</h5>
        <ul class="mb-3">
          <li><b>GET:</b> el usuario entra a la p√°gina ‚Üí solo mostramos el formulario vac√≠o.</li>
          <li><b>POST:</b> el usuario llena el formulario y presiona ‚ÄúEnviar‚Äù ‚Üí el servidor procesa los datos y el archivo.</li>
          <li>En Flask detectamos esto con <code>request.method</code>.</li>
        </ul>

        <h5 class="fw-bold mb-2">1) Importaciones</h5>
        <pre class="code-box mb-2"><code>import os
import random
import string
from flask import request, render_template_string</code></pre>
        <ul class="mb-3">
          <li><b>os</b>: crear rutas y carpetas para guardar la imagen.</li>
          <li><b>random</b> y <b>string</b>: generar nombres aleatorios para archivos.</li>
          <li><b>request</b>: contiene lo que el navegador env√≠a (POST, FILES, etc.).</li>
          <li><b>render_template_string</b>: renderiza HTML guardado en una variable.</li>
        </ul>

        <h5 class="fw-bold mb-2">2) Carpeta donde se guardar√°n las im√°genes</h5>
        <pre class="code-box mb-2"><code>BASE_DIR = os.path.dirname(os.path.abspath(__file__))
UPLOAD_FOLDER = os.path.join("static", "images")
os.makedirs(UPLOAD_FOLDER, exist_ok=True)</code></pre>
        <p class="mb-3">
          Se define una carpeta para subir im√°genes (<code>static/images</code>). Luego se crea si no existe.
          Lo recomendado es usar una ruta absoluta con <code>BASE_DIR</code> para evitar errores al guardar.
        </p>

        <h5 class="fw-bold mb-2">3) Crear un nombre aleatorio (evitar duplicados)</h5>
        <pre class="code-box mb-2"><code>def get_name_file(nombre_original, tamanio):
    ext = nombre_original.split('.')[-1]
    letras = string.ascii_letters
    nombre = ''.join(random.choice(letras) for _ in range(tamanio))
    return f"{nombre}.{ext}"</code></pre>
        <ul class="mb-3">
          <li>Se obtiene la extensi√≥n (jpg, png, etc.).</li>
          <li>Se genera un nombre aleatorio para no repetir archivos.</li>
          <li>Se devuelve: <code>nombre_aleatorio.ext</code>.</li>
        </ul>

        <h5 class="fw-bold mb-2">4) POST + FILES en Flask (comparaci√≥n con PHP)</h5>
        <p class="mb-2">
          En PHP usabas <code>$_POST</code> para datos de texto y <code>$_FILES</code> para archivos.
          En Flask se usa el objeto <code>request</code>:
        </p>

        <div class="row g-3 mb-3">
          <div class="col-md-6">
            <div class="p-3 border rounded-3 h-100">
              <h6 class="fw-bold">PHP</h6>
              <pre class="code-box mb-2"><code>$_POST["placa"]
$_FILES["foto"]["name"]</code></pre>
              <p class="hint mb-0">PHP separa datos y archivos en superglobales.</p>
            </div>
          </div>
          <div class="col-md-6">
            <div class="p-3 border rounded-3 h-100">
              <h6 class="fw-bold">Flask (Python)</h6>
              <pre class="code-box mb-2"><code>request.form.get("placa")
request.files.get("foto")</code></pre>
              <p class="hint mb-0">Flask usa <code>request.form</code> y <code>request.files</code>.</p>
            </div>
          </div>
        </div>

        <h5 class="fw-bold mb-2">5) Por qu√© es obligatorio: <code>multipart/form-data</code></h5>
        <p class="mb-2">
          Para que el navegador env√≠e un archivo correctamente, el formulario debe tener:
        </p>
        <pre class="code-box mb-3"><code>&lt;form method="post" enctype="multipart/form-data"&gt;</code></pre>
        <div class="alert alert-warning mb-3">
          Si no colocas <code>multipart/form-data</code>, <code>request.files</code> llegar√° vac√≠o aunque selecciones una imagen.
        </div>

        <h5 class="fw-bold mb-2">6) Detectar POST y leer los datos del formulario</h5>
        <pre class="code-box mb-2"><code>if request.method == 'POST':
    placa = request.form.get('placa')
    marca = request.form.get('marca')
    combustible = request.form.get('combustible')
    comentarios = request.form.get('comentarios')
    accesorios = request.form.get('accesorio')</code></pre>
        <p class="mb-3">
          Todo lo que NO es archivo (input, select, textarea, radio) llega en <code>request.form</code>.
          Usamos <code>.get()</code> para recuperar valores de forma segura.
        </p>

        <h5 class="fw-bold mb-2">7) Leer el archivo con <code>request.files</code></h5>
        <pre class="code-box mb-2"><code>foto = request.files.get('foto')
foto_url = None</code></pre>
        <p class="mb-3">
          Aqu√≠ Flask busca el archivo cuyo input tiene <code>name="foto"</code>.
          Si el usuario no sube nada, <code>foto</code> puede venir vac√≠o.
        </p>

        <h5 class="fw-bold mb-2">8) Guardar la imagen en el servidor</h5>
        <pre class="code-box mb-2"><code>if foto and foto.filename:
    nombre = get_name_file(foto.filename, 15)
    ruta = os.path.join(UPLOAD_FOLDER, nombre)
    foto.save(ruta)
    foto_url = f"/static/images/{nombre}"</code></pre>
        <ul class="mb-0">
          <li><b>foto.filename</b> verifica que s√≠ se eligi√≥ un archivo.</li>
          <li><code>foto.save(...)</code> guarda el archivo en tu proyecto.</li>
          <li><code>foto_url</code> es la ruta web que luego se usa en el HTML para mostrar la imagen.</li>
        </ul>

        <hr class="my-4">

        <h5 class="fw-bold mb-2">9) Renderizar el resultado (mostrar datos + imagen)</h5>
        <pre class="code-box"><code>return render_template_string(
    HTML,
    placa=placa,
    marca=marca,
    combustible=combustible,
    accesorios=accesorios,
    comentarios=comentarios,
    foto=foto_url,
    mostrar=True
)</code></pre>
        <p class="hint mt-2 mb-0">
          Se vuelve a renderizar el HTML, pero ahora con <code>mostrar=True</code> y con variables llenas para que se vea el resultado.
        </p>
      </div>

      <!-- ‚úÖ Ejecutar -->
      <div class="ej-actions">
        <a href="{{ url_for('ejecutar_ejercicio', slug=ejercicio.slug) }}#formulario"
           class="btn btn-primary btn-pill btn-lg">
          Ejecutar ejercicio
        </a>
      </div>

      <!-- Formulario / salida del ejercicio -->
      {% if contenido %}
      <div id="formulario" class="form-shell">
        <div class="form-card">
          {{ contenido|safe }}
        </div>
      </div>
      {% endif %}

      <!-- ‚úÖ Anterior / Siguiente -->
      <div class="ej-nav-bottom">

        {% if anterior %}
          <a href="{{ url_for('ver_ejercicio', slug=anterior['slug']) }}" class="btn btn-outline-primary btn-pill">
            <i class="bi bi-arrow-left me-1"></i> Anterior
          </a>
        {% else %}
          <button class="btn btn-outline-primary btn-pill" disabled>
            <i class="bi bi-arrow-left me-1"></i> Anterior
          </button>
        {% endif %}

        {% if siguiente %}
          <a href="{{ url_for('ver_ejercicio', slug=siguiente['slug']) }}" class="btn btn-primary btn-pill">
            Siguiente <i class="bi bi-arrow-right ms-1"></i>
          </a>
        {% else %}
          <button class="btn btn-primary btn-pill" disabled>
            Siguiente <i class="bi bi-arrow-right ms-1"></i>
          </button>
        {% endif %}

      </div>

    </div>
  </div>
</section>

{% endblock %}
